<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="css/mui.preview.css" />
		<script type="text/javascript" src="js/common.js" ></script>
		<style type="text/css">
			
			body {
				font-family: "微软雅黑";
			}
			
			/*
			 * 开始:顶部bar
			 */
			header {
				background-color: #6A7D8F !important;
				color: #FAFAFA;
			}
			
			h1 {
				color: #FAFAFA !important;
			}			
			header,
			h1 {
				height: 50px !important;
				line-height: 50px !important;
			}
			/*
			 * 结束：顶部bar
			 */
			
			
			/*
			 * 开始：按钮组css
			 */
			.select-content {
				margin-top: 50px;
				width: 100%;
				height: 205px;
				background-color: #81C6CD;
				/*text-align: center;*/
				padding: 10px 10px;
			}
			
			.select-content button {
				height: 35px;
				margin-bottom: 12px;
				width: 49%;
			}
			#ways{
				width: 100%;
			}
			
			.select-content input[type="text"] {
				height: 35px !important;
				width: 79%;
				font-size: 15px;
				margin: 0;
			}
			
			::-webkit-input-placeholder {
				font-size: 13px;
			}
			
			.inputgroup { /*车牌输入框*/
				width: 49%;
				display: inline-block;
			}
			
			.inte {
				display: inline-block;
				width: 17%;
				font-size: 15px;
				color: #FAFAFA;
				margin-right: 5px;
			}
			
			.all {  /*全选样式*/
				display: inline-block;
				width: 49%;
				height: 33px;
				font-size: 13px;
				text-align: center;
				color: #FAFAFA;
			}
			
			.all input::before {
				font-size: 21px !important;
				color: #FAFAFA !important;
			}
			
			.all label {
				font-size: 14px;
				padding-right: 30px;
			}
			/*
			 * 结束：按钮组css
			 */
			
			
			/*
			 * 审核区div
			 */
			
			/*.mui-control-content span {
				font-size: 16px;
				display: inline-block;
				height: 10vh;
				line-height: 10vh;
				padding: 0 3vh;
				margin-top: 1vh;
			}*/
			.checkname{
				display: block;
				margin: 28px 20px;
			}
			.mui-control-content .mui-icon-camera {
				display: inline-block;
				font-size: 30px;
				line-height: 20px;
				position: absolute;
				left: 40%;
			}
			
			.mui-control-content li {
				font-size: 15px;
			}
			
			.xpic {  /*拍照后显示的相册icon*/
				width: 8vh !important;
				height: 28px;
				float: right;
				margin-right: 2vh;
				border-radius: 5px;
				font-size: 25px !important;
/*				display: none;*/
			}
			
			.mui-content { /*审核区内容容器*/
				padding: 0 !important;
			}
			
			.mui-content-padded {
				margin: 0px !important;
			}
			
			.mui-segmented-control {
				border-radius: 0px;
				font-size: 13px;
			}
			
			/*底部结束分割线*/
			.endborder {
				padding-top: 1px;
			}
	
			.endborder hr {
				border-top: 1px solid #AAAAAA;
			}
			/*底部结束分割线文字*/
	
			.hrtext {
				position: relative;
				width: 75px;
				background-color: #EFEFF4;
				left: 40%;
				text-align: center;
				top: -20px;
				padding: 0 2%;
				font-size: 15px;
				color: #AAAAAA;
			}	
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<span class="mui-icon mui-icon-arrowleft mui-action-back"></span>
			<h1 class="mui-title"></h1>
		</header>

		<div class="select-content">
			<button type="button" class="mui-btn" id="ways">点击选择线路</button>
			<div class="inputgroup">
				<span class="inte">粤S</span><input type="text" id="carnumber" maxlength="6" onpaste="return false" ondragenter="return false"  onkeyup="this.value=check(this.value)" placeholder="请输入车牌号" />
			</div>
			<button type="button" class="mui-btn" id="weather">晴天</button>
			<button type="button" class="mui-btn" id="times">请选择上车时间</button>
			<div class="mui-input-row mui-checkbox all">
				<input  name="check1" type="checkbox" class="sall"></input>
				<label>全选为合格</label>
			</div>
			<button type="button" data-loading-text="正在保存" class="mui-btn mui-btn-primary" id="save">保存</button>
			<button type="button" data-loading-text="正在提交" class="mui-btn mui-btn-danger" id="subm">提交</button>
			<div id="SavePopover" class="mui-popover">
			  <li class="mui-table-view-cell" style="list-style: none;">
			  	<a href="#">请选择要保存的项目：</a>
			  	<button type="button" class="mui-btn mui-btn-primary" id="btnsave" style="width: 25%;">确定</button>
			  </li>
			 	 <div class="mui-input-row mui-checkbox">
  					<label>车辆整洁</label>
  					<input name="checkbox1" value="carzj" type="checkbox">
				</div>
			 	 <div class="mui-input-row mui-checkbox">
  					<label>车内服务设施</label>
  					<input name="checkbox1" value="carss" type="checkbox">
				</div>				
			 	 <div class="mui-input-row mui-checkbox">
  					<label>车厢服务</label>
  					<input name="checkbox1" value="carfw" type="checkbox">
				</div>			
			 	 <div class="mui-input-row mui-checkbox" style="display: none;">
  					<label>乘客满意度</label>
  					<input name="checkbox1" value="carmy" type="checkbox">
				</div>
			</div>
			<div id="SubmitPopover" class="mui-popover">
			  <li class="mui-table-view-cell" style="list-style: none;">
			  	<a href="#">请选择要提交的项目：</a>
			  	<button type="button" class="mui-btn mui-btn-primary" id="btnsubmit" style="width: 25%;">确定</button>
			  </li>
			 	 <div class="mui-input-row mui-checkbox">
  					<label>车辆整洁</label>
  					<input name="checkbox2" value="carzj" type="checkbox">
				</div>	
			 	 <div class="mui-input-row mui-checkbox">
  					<label>车内服务设施</label>
  					<input name="checkbox2" value="carss" type="checkbox">
				</div>	
			 	 <div class="mui-input-row mui-checkbox">
  					<label>车厢服务</label>
  					<input name="checkbox2" value="carfw" type="checkbox">
				</div>				
			 	 <div class="mui-input-row mui-checkbox" style="display: none;">
  					<label>乘客满意度</label>
  					<input name="checkbox2" value="carmy" type="checkbox">
				</div>
			</div>			
		</div>

		<div class="mui-content">
			<div class="mui-content-padded">
				<div class="mui-segmented-control">

				</div>
			</div>
			<div id="item1" class="mui-control-content">

			</div>
			<div id="item2" class="mui-control-content">

			</div>
			<div id="item3" class="mui-control-content">

			</div>
			<div id="item4" class="mui-control-content">
				
			</div>
		</div>

		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/mui.picker.min.js"></script>
		<script type="text/javascript" src="js/jquery-3.2.1.js"></script>
		<script type="text/javascript" src="js/mui.zoom.js" ></script>
		<script type="text/javascript" src="js/mui.previewimage.js" ></script>
		<script type="text/javascript">
			
			/*
			 * 初始化右滑关闭
			 */
			mui.init({
				swipeBack:true,
			});
			
			var o_back = mui.back;
			mui.back = function(){
				$('#ways').html("点击选择线路");
				$('#ways').css('color','black');
				$('#ways').css('background-color','#FFFFFF');
				$('#weather').html("晴天");
				$('#weather').css('color','black');
				$('#weather').css('background-color','#FFFFFF');
				$('#times').html("请选择上车时间");
				$('#times').css('color','black');
				$('#times').css('background-color','#FFFFFF');	
				$('#carnumber').val("");
				o_back();
			}			
			
			var files=[]; //存放图片的变量
			var onlyMy = false; //判断是否只有乘客满意度这个选项					
			
			/*
			 * 线路选择
			 */
			mui('.select-content').on('tap','#ways',function(){
				mui.openWindow({
					url:'selectways.html',
					id:'selectways',
					waiting:{
							autoShow:false
					}					
				});
			});			
			
			//天气选择器
			var weather_picker = new mui.PopPicker();
			picker_initial();
			function picker_initial(){
					weather_picker.setData([{
						value: "overcast",
						text: "阴天"
					}, {
						value: "blustery",
						text: "大风"
					}, {
						value: "sunny",
						text: "晴天"
					}, {
						value: "haze",
						text: "雾霾"
					}, {
						value: "shower",
						text: "阵雨"
					}, {
						value: "rainstorm",
						text: "暴雨"
					}])
					weather_picker.pickers[0].setSelectedValue('sunny',2000);					
			}			
			mui('.select-content').on('tap','#weather',function(){
				weather_picker.show(function(SelectedItem) {
					var weather = document.getElementById('weather');
					weather.innerHTML = SelectedItem[0].text;
					weather.style.color = '#FAFAFA';
					weather.style.backgroundColor = '#2AC845';
				});				
			});
			mui('.select-content').on('tap','#times',function(){
				var dtPicker = new mui.DtPicker();
					dtPicker.show(function(selectItems) {
						var times = document.getElementById('times');
						times.innerHTML = selectItems.value;
						times.style.color = '#FAFAFA';
						times.style.backgroundColor = '#2AC845';
						dtPicker.dispose();
					});					
			})
			
			/*
			 * 加载巡检类型及类型对应的巡检项目
			 */
			var num = 1;//拍照图标标识符,作为id名称
			var tabid = 0;
			mui.ajax({
				url:config.getAllCheckType,
				dataType:"json",
				type:"GET",
				async:false,
				crossDomain:true,
				success:function(data){
					console.log('巡检四大项目请求成功');
					var Atext = '';
					var count = 0;
					for(var i=0;i<data.jsonData.length;i++){					
						tabid = data.jsonData[i].codeSeq;
						if( i === 1){
							Atext = '<a class="mui-control-item" href="#item'+data.jsonData[i+1].codeSeq+'" id="'+data.jsonData[i+1].codeId+'">'+data.jsonData[i+1].valueName+'</a>';							
						}else if( i === 2){
							Atext = '<a class="mui-control-item" href="#item'+data.jsonData[i-1].codeSeq+'" id="'+data.jsonData[i-1].codeId+'">'+data.jsonData[i-1].valueName+'</a>';														
						}else{
							Atext = '<a class="mui-control-item" href="#item'+data.jsonData[i].codeSeq+'" id="'+data.jsonData[i].codeId+'">'+data.jsonData[i].valueName+'</a>';														
						}
						$('.mui-segmented-control').append(Atext);
						mui.ajax({
							url:config.getCheckItem,
							dataType:"json",	
							type:"GET",
							async:false,
							data:{
								"checktype":data.jsonData[i].codeId,
								"numPerPage":"50"
							},
							success:function(data){
								console.log('巡检四大项目中的小项目请求成功');
								count++;
								console.log(count);							
								var list = data.jsonData.list;
								for(var j=0;j<list.length;j++){
									var inner = '';
									inner+='<div class="check">';
										inner+='<div class="checkname">';
										inner+='<span>'+list[j].itemname+'</span>';
//										<!--<img src="images/1.png" class="xpic" id="pic1" data-preview-src="" data-preview-group="1"/>-->
										inner+='<span class="mui-icon mui-icon-camera" id="ca'+num+'"></span>';
										inner+='</div>';
										inner+='<input type="hidden" name="sccguid" value="'+list[j].sccguid+'">';
										inner+='<ul class="mui-table-view mui-table-view-radio">';
										    if(list[j].escore!=-1){
										    	inner+='<li class="mui-table-view-cell excellent">';
													inner+='<a class="mui-navigate-right">优秀</a>';
													inner+='<input type="hidden" value="'+list[j].escore+'" />';
												inner+='</li>';
										    }
										    if(list[j].gscore!=-1){
												inner+='<li class="mui-table-view-cell fine">';
													inner+='<a class="mui-navigate-right">良好</a>';
													inner+='<input type="hidden" value="'+list[j].gscore+'" />';
												inner+='</li>';											    	
										    }
										    if(list[j].mscore!=-1){
												inner+='<li class="mui-table-view-cell pass">';
													inner+='<a class="mui-navigate-right">合格</a>';
													inner+='<input type="hidden" value="'+list[j].mscore+'" />';
												inner+='</li>';										    	
										    }
										    if(list[j].bscore!=-1){
												inner+='<li class="mui-table-view-cell fail">';
													inner+='<a class="mui-navigate-right">不合格</a>';
													inner+='<input type="hidden" value="'+list[j].bscore+'" />';
												inner+='</li>';										    	
										    }										
										inner+='</ul>';
									inner+='</div>';
									num++;
									$('#item'+tabid).append(inner);		
								}
								$('#item'+tabid).append('<div class="mui-input-row" style="margin: 10px 5px;"><textarea id="textarea" rows="5" placeholder="巡检备注(选填)"></textarea></div>');
								$('#item'+tabid).append('<div class="endborder checkedlist"><hr><div class="hrtext">到底啦</div></div>');									
								if(count === 4){
									plus.nativeUI.closeWaiting();								
								}
							}
						});						
					}	
				}
			});			
			
			
			/*
			 * 全选监听事件开始
			 */
				mui('.mui-segmented-control').on("tap",".mui-control-item",function(){
					index = $(this).index();
					if(index === 1){
						index = 2;
					}else if(index === 2){
						index = 1;
					}	
					$('.mui-content>.mui-control-content').eq(index).find('.pass').each(function(){
						if($(this).hasClass('mui-selected')){
							$(".sall").prop("checked", true);
						}else{
							$(".sall").prop("checked", false);//jq高于1.6必须使用prop来对元素属性的布尔值进行操作，若在元素标签中可见的如src就用attr	
						}
					});				
				});
				mui('.select-content').on("tap",".all",function(){ //onclick 与 ontap 的checked的初始属性值相反，click为true，tap为false
					_this = $('.all').find('.sall')[0];
					var isAll = _this.checked;
					if(isAll == false){
						$('.mui-content>.mui-control-content').eq(index).find('.pass').each(function(){
							if(!$(this).hasClass('mui-selected'))
								$(this).addClass('mui-selected');
						});	
						$('.mui-content>.mui-control-content').eq(index).find('.fail').each(function(){
							if($(this).hasClass('mui-selected'))
								$(this).removeClass('mui-selected');
						});
						$('.mui-content>.mui-control-content').eq(index).find('.excellent').each(function(){
							if($(this).hasClass('mui-selected'))
								$(this).removeClass('mui-selected');
						});
						$('.mui-content>.mui-control-content').eq(index).find('.fine').each(function(){
							if($(this).hasClass('mui-selected'))
								$(this).removeClass('mui-selected');
						});						
					}else{
						$('.mui-content>.mui-control-content').eq(index).find('.pass').each(function(){
							if($(this).hasClass('mui-selected'))
								$(this).removeClass('mui-selected');
						});
					}
					
				})
			/*
			 * 全选事件监听结束
			 */				 
			
		    var index = 0; //选中的选项卡索引
		    var carid =''; //评选列表的按钮ID
		    var self; //指当前窗口
		    var PlanPage = null;
		    var showPage = null;
			mui.plusReady(function(){
				plus.navigator.setStatusBarBackground("#6A7D8F"); //plus模块加载完后再调整APP顶部栏颜色	
				PlanPage = plus.webview.getWebviewById('checkplan.html');
				showPage = plus.webview.getWebviewById('show.html');
					$('.mui-segmented-control>a').each(function(){
						if($(this).hasClass('mui-active')){
							index = $(this).index();  ///通过首页点击某一区块 进行类名查询后对index赋予被激活的类的index值
						}
					});
					
					/*
					 * 监听每个评分项目的拍照icon
					 */
					$('.mui-control-content>div>div>.mui-icon-camera').each(function(){
						mui('.mui-control-content>div').on("tap","#"+$(this).attr('id')+"",function(){
							var carnumFlag = false;
							if(!onlyMy){
								carnumFlag = $('#carnumber').val() == "" ? true : false;
							}
							if($('#ways').html() =="点击选择线路" ||carnumFlag){
								mui.alert('请将车辆信息填写完毕');
							}else{
								carid = $(this).attr('id');
								plus.nativeUI.actionSheet( {title:"选择照片",cancel:"取消",buttons:[{title:"即时拍照"},{title:"从相册选取"}]}, function(e){
									switch (e.index){
										case 0:
											break;
										case 1:
											console.log("用户点击了ID为"+carid+"的相机按钮,接下来的操作是：拍照获取相片");
											captureImage(carid);
											break;
										case 2:
											console.log("用户点击了ID为"+carid+"的相机按钮,接下来的操作是：选取现有相片");
											galleryImg(carid);
											break;
										default:
											break;
									}
								});								
							}
						});
					});	
			});
			
			/*
			 * 监听plus模块加载结束
			 */
						
			/*
			 * 开始：从相册中选取图片
			 */
				function galleryImg(carid) {
				    plus.gallery.pick( function(path){
						appendFile(path,carid);
				    }, function ( e ) {
				    	console.log( "取消选择图片" );
				    }, {filter:"image"} );
				}
			/*
			 * 结束：从相册中选取图片
			 */
			
			/*
			 * 拍照模块开始
			 */				
				function captureImage(carid) {
					var cmr = plus.camera.getCamera();
					var res = cmr.supportedImageResolutions[0];
					var fmt = cmr.supportedImageFormats[0];
//					var picid = 'pic'+carid.toString().replace(/ca/g, "");
//					console.log("Resolution: " + res + ", Format: " + fmt);
					cmr.captureImage(function(e) {
//							alert("Capture image success: " + e);
							plus.io.resolveLocalFileSystemURL(e, function(entry) {
								var path = entry.toLocalURL();
								appendFile(path,carid);
							});
						},
						function(error) {
							console.log("图片获取失败,原因为: " + error.message);
						}, {
							resolution: res,
							format: fmt
						}
					);
				}
			/*
			 * 拍照模块结束
			 */
			
			/*
			 * 开始：图片压缩
			 */
				var imgArr = [];//存放图片base64的数组
				var imgNum = [];//图片编号数组
				var num = 0;
				function appendFile(path,carid){
					var cargroup = 0; //相片组标识组号
					var carnum = carid.toString().replace(/ca/g, ""); //筛选剩数字
					var picid = 'pic'+carnum;
					console.log(path);
					
					var img = new Image();
				        img.src = path;        // 传过来的图片路径在这里用。
				        img.onload = function () {
				            var that = this;
				            //生成比例 
				            var w = that.width,
				                h = that.height,
				                scale = w / h; 
				                w = 480 || w;              //480  你想压缩到多大，改这里
				                h = w / scale;
				
				            //生成canvas
				            var canvas = document.createElement('canvas');				
				            var ctx = canvas.getContext('2d');	
				            var imgfile;
				            $(canvas).attr({width : w, height : h});			
				            ctx.drawImage(that, 0, 0, w, h);
				            /*
				             * 水印绘制开始
				             */
				            ctx.font = "15px microsoft yahei";
				            ctx.fillStyle = "#FAFAFA";
             				ctx.fillText('线路：'+$('#ways').html(),5,h-67);
             				ctx.fillText('车牌：粤S '+$('#carnumber').val(),5,h-48);
				            ctx.fillText('巡检项目：'+$('#'+carid).prev().html(),5,h-29);             				
             				ctx.fillText("拍摄时间："+getNow(),5,h-10); 
             				/*
             				 * 水印绘制结束
             				 */
				            var base64 = canvas.toDataURL('image/jpeg', 1 || 0.8 ); //将图片转化成base64
				            base64tobitmap(base64,picid,carid); //从base64转为图片，并保存到系统文件目录下
				    	}
				
				}
				/*
				 * 结束：图片压缩
				 */
				
				/*
				 * 将base64图片转为bitmap图片再保存到本地,待图片保存完后对相册按钮进行监听
				 */
				var flagkey = 1;
				function base64tobitmap(base64,picid,carid){
					var bitmap = new plus.nativeObj.Bitmap();
					bitmap.loadBase64Data(base64,function(){						
						var timestamp = (new Date()).valueOf();
						bitmap.save("_doc/"+picid+"-"+timestamp+".jpg",{
							overwrite:true,
							quality:100
						},function(eve){
							console.log('图片保存成功,路径为：'+eve.target+',大小为:'+eve.size);
							var fullname=eve.target.substr(eve.target.lastIndexOf('/')+1);
							var filen = fullname.split('.')[0];
							console.log(filen);
							files.push({name:"uploadkey"+flagkey,path:eve.target});
							flagkey++;							
							if($("#"+picid).length<=0){									
				            	$("#"+carid).before('<span class="mui-icon mui-icon-image xpic" id="'+picid+'"></span>');
				            	$("#"+picid).before('<img src="'+eve.target+'" id="'+filen+'" class="'+picid+'" style="display:none;" />');
				            	mui.toast('图片添加成功,点击右方图标进行查看。');
				            	mui('.mui-control-content').on('tap','#'+picid,function(){
				            		$('.'+picid).each(function(){
				            			if($.inArray($(this).attr('src'),imgArr) == -1){//判断数组中有无该图片
				            				imgArr.push(picid,$(this).attr('src'));
				            				imgNum.push(num++);
				            			}
				            		})
									
				            		mui.openWindow({
										url: 'album.html',
										id: 'album',
										extras:{
											imgArray: imgArr,
											imgNumber: imgNum,
											curCarid: picid
										},
										waiting:{
											autoShow:false
										}
									});
									imgArr.splice(0,imgArr.length); //当前栏目的图片显示至相册后清空数组，等待一下次Tap事件重新获取图片
				            	})
							}else{
								$("#"+picid).before('<img src="'+eve.target+'" id="'+filen+'" class="'+picid+'" style="display:none;" />');
								mui.toast('图片添加成功,点击右方图标进行查看。');
							}							
						},function(error){
							console.log('图片保存失败,原因：'+error.Message);
						});
					},function(e){
						console.log('图片加载失败,原因：'+e.Message);
					})
				}				
			
			/*
			 *格式化当前时间 
			 */
			function getNow(){
				var myData = new Date();
				var year = myData.getFullYear();
				var month = myData.getMonth()+1;
				var ndate = myData.getDate();
				var h = myData.getHours();
				var m = myData.getMinutes();
				var s = myData.getSeconds();
				var now = year+'-'+p(month)+"-"+p(ndate)+" "+p(h)+':'+p(m)+":"+p(s);
				return now;
			}
			function p(s) {
    			return s < 10 ? '0' + s: s;
			}
			/*
			 *监听imgArr参数的改变 ,如果照片在相册被删除则重新遍历DOM
			 */
			window.addEventListener('changePic',function(event){
				var data = event.detail.data;
				if(data.length == 1){ //相册数组被完全删除后会自动记录图片按钮ID
					$('.'+data[0]).remove();
					$('#'+data[0]).remove();
					files.splice(0,files.length);//清空图片数组
				}else if($('.'+data[0]).length != data.length/2){
					files.splice(0,files.length);//清空图片数组
					$('.'+data[0]).remove();
					for(var j=0;j<data.length/2;j++){
						console.log(data[2*j]);
						var fullname = data[2*j+1].substr(data[2*j+1].lastIndexOf('/')+1);
						var filen = fullname.split('.')[0];
						console.log(filen);
						files.push({name:"uploadkey"+filen,path:data[2*j+1]});						
						$('#'+data[2*j]).before('<img src="'+data[2*j+1]+'" class="'+data[2*j]+'" style="display:none;" />');
					}
				}else{
					console.log('未删除相片');
				}
			});
			
			/*
			 * 监听从主页面点击进来的巡检项目图片块，并设置对应的巡检项目块的类为active
			 */
			window.addEventListener('getActive',function(eve){
				var block = eve.detail.block;
				if(block === 2){
					block = 3;
				}else if(block === 3){
					block = 2;
				}
				console.log('点击了'+block);
				if(block === 4){
					$('.mui-title').html('乘客满意度调查表');
					$('.all').hide();
					$('.inputgroup').hide();
					$('.select-content').css('height','150px');
				}else{
					$('.mui-title').html('车辆临时巡检');
					$('.all').show();
					$('.inputgroup').show();
					$('.select-content').css('height','205px');
				}
				$(".sall").prop("checked", false);
				index = block-1;
				$("a[href='#item"+block+"']").addClass('mui-active');
				$('#item'+block).addClass('mui-active');	
				$("a[href='#item"+block+"']").siblings().removeClass('mui-active');
				$('#item'+block).siblings().removeClass('mui-active');
				if(block>0&&block<4){
					onlyMy = false;
					$("a[href='#item4']").hide();					
					for(var i=1;i<4;i++){
						$("a[href='#item"+i+"']").show();
					}
				}else{
					onlyMy = true;
					$("a[href='#item"+block+"']").show();
					for(var i=1;i<block;i++){
						$("a[href='#item"+i+"']").hide();
					}
				}
			});
			
			/*
			 * 开始：保存及提交loading动画函数
			 */
				//保存
				mui('.select-content').on('tap', '#save', function(e) {
					var carnumFlag = false;
					if(!onlyMy){
						carnumFlag = $('#carnumber').val() == "" ? true : false;
					}
					if($('#ways').html() =="点击选择线路" || carnumFlag || $('#times').html() == "请选择上车时间"){
						mui.alert('请将车辆信息填写完毕');						
					}else{
						if(onlyMy){
							var SaveObject = $('#SavePopover').find("input[value='carmy']");
							upload(SaveObject,'save');
							mui('#save').button('loading');	
						}else{
							checkedByitem('#SavePopover');
							mui('#SavePopover').popover('show',this);													
						}
					}					
				});
				mui('#SavePopover').on('tap','#btnsave',function(){
					mui('#SavePopover').popover('hide',this);
					var SaveObject = $('#SavePopover').find("input[name='checkbox1']:checked");					
					upload(SaveObject,'save');
					var time=new Date();					
					mui('#save').button('loading');					
				});	
				
				
				//提交
				mui('.select-content').on('tap', '#subm', function(e) {
					var carnumFlag = false;
					if(!onlyMy){
						carnumFlag = $('#carnumber').val() == "" ? true : false;
					}					
					if($('#ways').html() =="请选择线路" ||carnumFlag ||$('#times').html() == "请选择上车时间"){
						mui.alert('请将车辆信息填写完毕');
					}else{
						if(onlyMy){
							var SubmitObject = $('#SubmitPopover').find("input[value='carmy']");
							upload(SubmitObject,'submit');
							mui('#subm').button('loading');		
						}else{
							checkedByitem('#SubmitPopover');
							mui('#SubmitPopover').popover('show',this);																								
						}
					}
				});
				mui('#SubmitPopover').on('tap','#btnsubmit',function(){
					mui('#SubmitPopover').popover('hide',this);
					var SubmitObject = $('#SubmitPopover').find("input[name='checkbox2']:checked");
					upload(SubmitObject,'submit');
					var time=new Date();					
					mui('#subm').button('loading');						
				});				
			/*
			 * 结束：保存及提交loading动画函数
			 */
			
			function checkedByitem(OptionItem){
				$('.mui-content>.mui-control-content').each(function(){
					var checkLen = $(this).children('.check').length;
					var hadCheckLen = $(this).find('.mui-selected').length;
					var finishId = $(this).attr('id');
					var inputVal = "";
					switch (finishId){
						case 'item1':
							inputVal = 'carzj';
							break;
						case 'item2':
							inputVal = 'carfw';
							break;
						case 'item3':
							inputVal = 'carss';
							break;											
						default:
							break;
					}								
					if(checkLen === hadCheckLen){	
						var finishItem = $('.mui-segmented-control').find("[href='#"+finishId+"']").html();
						console.log(finishId);
						console.log($('.mui-segmented-control').find("[href='#"+finishId+"']").html());
						$(OptionItem).find("input[value='"+inputVal+"']").prop('checked',true);
					}else{
						$(OptionItem).find("input[value='"+inputVal+"']").prop('checked',false);
					}
				});				
			}
			
			var server = config.imageUpload;
			function upload(Htmlobject,OptionType){
				var item = '';
				var emptyli = 0;
				var uploaditem = new Array();
				var issubmit = OptionType == "save" ? 0 : 1;
				var alertText = OptionType == "save" ? '保存成功' : '提交成功';
				if(Htmlobject.length == 0){
					mui.alert('请选择要保存的项目',function(){
						if(issubmit == 0){
							mui('#save').button('reset');
						}else{
							mui('#subm').button('reset');
						}					
					});
				}else{
					Htmlobject.each(function(){
						var choice = $(this).val();
						console.log(choice);
						switch (choice){
							case 'carzj':
								item = 'item1';
								break;
							case 'carfw':
								item = 'item2';
								break;
							case 'carss':
								item = 'item3';
								break;
							case 'carmy':
								item = 'item4';
								break;									
						}	
						uploaditem.push(item);
						var HadChecked = $('#'+item+'>div').children('ul').find('.mui-selected');
						var quantity = 2; //默认只有及格与不及格两个选项
						if($('a[href="#'+item+'"]').html() == "乘客满意度"){//乘客满意度为特例需要变更为4个
							quantity = 4;
						}
						console.log('h:'+HadChecked.length);
						var NeedtoCheckLength = $('#'+item+'>div').children('ul').find('li').length/quantity;
						console.log('n:'+NeedtoCheckLength);
						if(HadChecked.length<NeedtoCheckLength){
							emptyli++;
						}					
					});	
					if(emptyli>0){
						console.log(emptyli);
						mui.alert('请先对所有需上传的巡检项目进行评分',function(){
							if(issubmit == 0){
								mui('#save').button('reset');
							}else{
								mui('#subm').button('reset');
							}						
						});						
					}else{
						console.log(server);
						var task=plus.uploader.createUpload(server,
							{method:"POST"},
							function(t,status){ //上传完成
								if(status==200){
									console.log("上传成功")
									var filename=t.responseText.split(",");
									$('img').each(function(){
										console.log('修改前：'+$(this).attr('id'));
									})
									for(var i=0;i<filename.length-1;i++){
										var oldname=filename[i].split(".")[0];
										var newname=filename[i].split(".")[2];
										$('img').each(function(){
											if($(this).attr('id') == oldname){
												$(this).attr('id',newname);
											}
										});
									}
									$('img').each(function(){
										console.log('修改后：'+$(this).attr('id'));
									});
									plus.storage.setItem("uploader",t.responseText);
									DataOperation(uploaditem,OptionType);
								}else{
									console.log("上传失败")
			//						wt.close();
								}
							}
						);
						task.addData("client","HelloH5+");
						task.addData("uid",getUid());
						for(var i=0;i<files.length;i++){
							var f=files[i];
							console.log(f.path);
							task.addFile(f.path,{key:f.name});
						}
						task.start();						
					}
				}
			}
			// 产生一个随机数
			function getUid(){
				return Math.floor(Math.random()*100000000+10000000).toString();
			}			
			
			function DataOperation(uploaditem,OptionType){
						console.log('可以开始上传了');
						console.log('要上传的项目的数组长度：'+uploaditem.length);
						var issubmit = OptionType == "save" ? 0 : 1;
						var alertText = OptionType == "save" ? '保存成功' : '提交成功';						
						var succRes = 0;
						var saveContent = [];						
						for(var i=0;i<uploaditem.length;i++){
//							console.log(uploaditem[i]);
							var detailArray = new Array();//存放单项评选数据的数组
							var itemContent = {};
							$('#'+uploaditem[i]+'>.check').each(function(){
								var sccguid=$(this).find("input[name='sccguid']").val();
								var checkScore = $(this).children('ul').find('.mui-selected').find("input").val();
								var imggroup = $(this).find('img').length;
								var imgurl = '';
								if(imggroup>0){
									$(this).find('img').each(function(){
										imgurl += config.imageShow+'/'+$(this).attr('id')+".jpg,";
									});		
									imgurl = imgurl.trim(',');
								}								
//								console.log("sccguid:"+sccguid);
//								console.log("checkScore:"+checkScore);
//								console.log("imgurl:"+imgurl);
//								console.log("################");
								var detailJson = {"scdguid":"","sccguid":sccguid,"checkscore":checkScore,"imgurl":imgurl};
								detailArray.push(detailJson);
							});	
							console.log($('#'+uploaditem[i]+'>.mui-input-row>textarea').val());
							itemContent={
								"scrguid":"",
								"scpguid":"",
								"busno":$('#carnumber').val(),
								"remark": $('#'+uploaditem[i]+'>.mui-input-row>textarea').val(),
								"weather":$('#weather').html(),
								"bustime":$('#times').html(),
								"issubmit":issubmit+"",   //0:保存，1:提交
								"checkline" : $('#ways').html(),
								"pageFlag" : "1",
								"checktype" : $('a[href="#'+uploaditem[i]+'"]').attr('id'),
								"planno" : "",
								"detail":detailArray
							};	
//							console.log('scrguid:'+itemContent.scrguid);
//							console.log('scpguid:'+itemContent.scpguid);
//							console.log('busno:'+itemContent.busno);
//							console.log('remark:'+itemContent.remark);
//							console.log('weather:'+itemContent.weather);
//							console.log('bustime:'+itemContent.bustime);
//							console.log('issubmit:'+itemContent.issubmit);
//							console.log('checkline:'+itemContent.checkline);
//							console.log('pageFlag:'+itemContent.pageFlag);
//							console.log('checktype:'+itemContent.checktype);
//							console.log('planno:'+itemContent.planno);
//							console.log('detail-length:'+itemContent.detail.length);							
							saveContent.push(itemContent);
//							console.log(saveContent.length);
						}
						$.ajax({
							url:config.TempCheckPlanOperation,
							dataType:"json",	
							type:"POST",
							async:false,
							data:{
								"saveContent":JSON.stringify(saveContent)
							},
							success:function(data){
								succRes++;
							},
							error:function(xhr,type,errorThrown){
								console.log(errorThrown);
							}
						});						
//						console.log('succ:'+succRes);
						var Altext = '';
						if( succRes > 0 ){
							Altext = alertText;
						}else{
							Altext = "计划添加失败,请重新添加"
						}
						if(issubmit == 0){
							mui('#save').button('reset');
						}else{
							mui('#subm').button('reset');
						}						
						mui.alert(Altext,'',function(){
							mui.fire(PlanPage,"refreshData",{
									
							});							
							location.reload();
							mui.back();
							if(issubmit == 1){
								mui.fire(showPage,"reload",{
									
								});								
							}							
						});						

//				console.log(item);
			}
			
			//监听线路变化
			window.addEventListener('changeLine',function(eve){
				$('#ways').html(eve.detail.line);
				$('#ways').css('color','#FAFAFA');
				$('#ways').css('background-color','#2AC845')
			});
			
		</script>
	</body>

</html>